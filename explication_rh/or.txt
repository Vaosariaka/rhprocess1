C-Gestion du temps et des présences :
.Feuille de temps / pointage (manuel ou automatique via badgeuse ou application 
    mobile) {
    *gestion de systeme de pointage
    *pointage :
        -retard et non présence, si le congé a encore du reste, alors ça sera soustrait avec le congé car c'est pareil qu'une absence non autorisé
        mais si y'a plus de reste, ça sera soustrait avec le salaire

        -soustrait avec le salaire =
            .a un taux horaire car tu dois evaluer par rapport a l'argent
            .2,5 X taux journalier puis convertis en taux horaire combien ?
        
        -mais si soustrait avec congé => devient par jour ou journalier qu'on soustrait pas comme le salaire par heures(taux horaires)


        SI (solde_congés > 0):
            → Déduire du congé (1 absence = 1 jour de congé déduit)
        SINON:
            → Déduire du salaire (selon le temps manqué)

        Calcul de déduction sur salaire :
        Formule :
        Salaire mensuel = 1,000,000 Ar
        Taux journalier = Salaire / 30 = 1,000,000 / 30 = 33,333 Ar/jour

        Pour retard/absence :
        Pénalité = 2.5 × Taux journalier = 2.5 × 33,333 = 83,333 Ar (par jour d'absence)

        Taux horaire = Salaire / 173.33 (heures/mois) = 1,000,000 / 173.33 = 5,769 Ar/heure

        Pour un retard de 90 minutes (1.5h) :
        Déduction = 1.5 × 5,769 = 8,654 Ar

        Différence entre déduction congé vs salaire :
        | Type | Unité | Calcul |
        |------|-------|--------|
        | **Déduction congé** | Jours entiers | 1 absence = -1 jour de congé |
        | **Déduction salaire (absence)** | Pénalité | 2.5 × (Salaire/30) par jour |
        | **Déduction salaire (retard)** | Heures | (Heures de retard) × (Salaire/173.33) |
}

.Heures supplementaires {
    *heures supplémentaires :
        -principe calcul heure supp =
            .en general par semaine, paiement heure supp
            .devrait pas depasser 20h par semaine HeureSup car 40h/semaine est le droit des emp avec heure normale (8h*5j) donc 8h/j de travail
                alors HeureSup autorisé => la moitié donc 20h / semaine
            
            .comment on calcul ? car c'est heures supplementaires et non heures normales donc pas taux horaire normale qu'on le paye mais taux avec heures supplements
            .donc si on a taux horaires = 1442,34 <= comment on a obtenu ça
            .comment on calcul taux horaires ? => "TAUX HORAIRES NORMALES = (SALAIRE MENSUEL / 30) / 24" =>on prend salaire mensuel, on convertit en taux journalier(/30), et la reponse de ça /24 heures => base horaire => 1442.34 (taux horaires normales)
            .comment on calcul taux horaires sup ? => "TAUX HORAIRES SUPPLEMENTAIRES = (TAUX HORAIRES NORMALES * 1.3 * 8) (pour les 8premieres heures) + (TAUX HORAIRES NORMALES * 1.5 * 12) (pour les 12h restantes)"
            .mais heures supp => 8premiers heures et 12restant => 20h
            .8premiers heures majoré 30%
            .12restants majoré 50%
            .1442.34 X 1.3 X 8 = taux horaire heures supp pour les 8premieres heures
            .1442.34 * 1.5 * 12 = taux horaire heures supp pour les 12 restants :
                si par exemple : il a encore 20h alors pour les 8h c'est 1442.34 * 1.3 * 8 et pour les 12h c'est 1442.34 * 1.5 * 12
                   par exemple HeureSup = 12h et non 20h, 8premieres heures majorés 30% = 8h et 4restants majorés 50% = 4h donc TAUX HORAIRES SUPP = (TAUX HORAIRES NORM * 1.3 * 8) + (TAUX HORAIRES NORM * 1.5 * 4)
            .et cela par semaine pour avoir la total d'heures supplementaires par mois => apres le Total de ça => on place dans le fiche de paie => voici l'heure supp de cet employé
        
        -heures normales majorés avec le taux d'HEURES SUP
        -salaire journalier = salaire de base / 30
        -apres qu'on ait atteint le salaire horaire => on va dire que c'est 1000Ar / heure (salaire normale)
        -normalement heures sup = 20h/semaines seulement 
        -la division de ces 20h sont 8 premiers heures majorés 30% et 12 restants majorés 50% donc si l'employé a 20h d'heures sup,
            a un taux horaire de 1000 Ar donc son heures sup = (1000Ar * 8 * 1.3) + (1000 * 12 * 1.5)  
        -on parle pas de heures normales car heures normales est deja calculer dans le salaire normale
        -si c'est 2h, l'heures sup est 1000 * 2 * 1.3 seulement
        

    # Dans core/payroll.py ligne ~94
    overtime_pay = (overtime_hours_from_pres * hourly).quantize(Decimal('0.01'))

    **Le code multiplie simplement** :
    overtime_pay = heures_sup × taux_horaire
                = 12h × 5,769.34 Ar/h
                = 69,232.08 Ar

    Ce qu'il DEVRAIT faire (selon votre prof)
    # Les 8 premières heures majorées à 30%
    first_8_hours = min(overtime_hours, 8)
    pay_first_8 = first_8_hours × hourly × 1.3

    # Les 12 heures suivantes majorées à 50%
    remaining_hours = max(0, overtime_hours - 8)
    next_12_hours = min(remaining_hours, 12)
    pay_next_12 = next_12_hours × hourly × 1.5

    overtime_pay = pay_first_8 + pay_next_12

    remplacer la ligne 94 dans payroll.py : # ❌ ANCIEN CODE (ligne ~94)
    overtime_pay = (overtime_hours_from_pres * hourly).quantize(Decimal('0.01'))

    en :
    # ✅ NOUVEAU CODE
    # Appliquer la majoration progressive : 8h à +30%, 12h suivantes à +50%
    if overtime_hours_from_pres > 0:
        # Les 8 premières heures majorées à 30%
        first_8_hours = min(overtime_hours_from_pres, Decimal('8'))
        pay_first_8 = (first_8_hours * hourly * Decimal('1.3')).quantize(Decimal('0.01'))
        
        # Les 12 heures suivantes majorées à 50%
        remaining_hours = max(Decimal('0'), overtime_hours_from_pres - Decimal('8'))
        next_12_hours = min(remaining_hours, Decimal('12'))
        pay_next_12 = (next_12_hours * hourly * Decimal('1.5')).quantize(Decimal('0.01'))
        
        overtime_pay = (pay_first_8 + pay_next_12).quantize(Decimal('0.01'))
    else:
        overtime_pay = Decimal('0')
    
    ces deux lignes dans payroll.py :
    # base overtime pay (hourly * overtime hours)
    overtime_pay = (overtime_hours_from_pres * hourly).quantize(Decimal('0.01'))
    # premiums: apply configured multipliers (e.g., NIGHT: 0.30 means +30% of base hourly)
    night_rate = Decimal(str(overtime_rates.get('NIGHT', DEFAULTS['OVERTIME_RATES']['NIGHT'])))

    remplacer par :
    # base overtime pay with progressive majoration (30% for first 8h, 50% for next 12h)
    if overtime_hours_from_pres > 0:
        # Maximum 20h overtime per week as per labor law
        overtime_capped = min(overtime_hours_from_pres, Decimal('20'))
        
        # First 8 hours: +30% majoration
        first_8_hours = min(overtime_capped, Decimal('8'))
        pay_first_8 = (first_8_hours * hourly * Decimal('1.3')).quantize(Decimal('0.01'))
        
        # Next 12 hours (if any): +50% majoration
        remaining_hours = max(Decimal('0'), overtime_capped - Decimal('8'))
        next_12_hours = min(remaining_hours, Decimal('12'))
        pay_next_12 = (next_12_hours * hourly * Decimal('1.5')).quantize(Decimal('0.01'))
        
        overtime_pay = (pay_first_8 + pay_next_12).quantize(Decimal('0.01'))
    else:
        overtime_pay = Decimal('0')

    # premiums: apply configured multipliers
    night_rate = Decimal(str(overtime_rates.get('NIGHT', DEFAULTS['OVERTIME_RATES']['NIGHT'])))

    avant :
      hourly = (salary_base / hours_per_month).quantize(Decimal('0.01'), rounding=ROUND_HALF_UP)
    else:
    remplacer par :
    hourly = salary_base / hours_per_month
}


.retards {
    -si le congé a encore du reste, alors ça sera soustrait avec le congé car c'est pareil qu'une absence non autorisé
        mais si y'a plus de reste, ça sera soustrait avec le salaire
    -soustrait avec le salaire =
        .a un taux horaire car tu dois evaluer par rapport a l'argent
        .2,5 X taux journalier puis convertis en taux horaire combien ? 
    -mais si soustrait avec congé => devient par jour ou journalier qu'on soustrait pas comme le salaire par heures(taux horaires)

    -finalité => si l'employé n'a plus de congé devrait etre integré dans le fiche de paie

    ✅ Ce qui FONCTIONNE (Implémenté) :
        1. Détection des retards
        ✓ Le système détecte et enregistre les retards dans core_presence
        ✓ 3 retards enregistrés : 120 min, 90 min, 150 min
        
        2. Système d'alertes
        ✓ Des alertes de type "LATE" sont créées automatiquement
        ✓ Messages clairs : "Late 150 minutes on 2025-11-28 for EMP001"
        ✓ Statut : OPEN (prêt pour traitement)
    
    ❌ Ce qui NE FONCTIONNE PAS (Non Implémenté)
    1. Aucune déduction automatique du solde de congés
    Votre situation :
        Solde de congés : 0 jour (10 - 10 = 0)
        Retards cumulés : 120 + 90 + 150 = 360 minutes = 6 heures
    Ce qui DEVRAIT se passer selon la règle : "Si le congé a encore du reste, alors ça sera soustrait avec le congé"
    Ce qui se passe RÉELLEMENT :
        used_days reste à 10.00 (inchangé)
        ❌ **Le système ne convertit PAS les retards en jours de congé**

    2. Aucune déduction automatique sur le salaire
    Votre situation :
        Solde de congés épuisé (0 jour)
        Retards = 360 minutes = 6 heures
    Calcul théorique attendu :
        Taux horaire : 1,000,000 / 173.33 = 5,769.34 Ar/h
        Taux majoré (x2.5) : 14,423.35 Ar/h
        Déduction pour 6h : 14,423.35 × 6 = 86,540 Ar
    Ce qui se passe RÉELLEMENT :
        deductions = 100,000.00 (valeur fixe, inchangée)
        notes = '' (vide, aucune explication)
        ❌ Le système ne calcule PAS les déductions liées aux retards
    
    3. Aucun lien entre les alertes et les actions
        3 alertes "LATE" créées → statut OPEN  
        Mais aucune action automatique déclenchée
        ❌ Les alertes sont juste informatives, pas opérationnelles
    
    resumé :
        | Composant | État | Détails |
        |-----------|------|---------|
        | **Enregistrement des retards** | ✅ Implémenté | `minutes_late` correctement sauvegardé |
        | **Création d'alertes** | ✅ Implémenté | Alertes "LATE" générées automatiquement |
        | **Déduction du solde de congés** | ❌ **NON implémenté** | `used_days` ne bouge pas |
        | **Déduction sur salaire** | ❌ **NON implémenté** | `deductions` ne calcule pas les retards |
        | **Conversion minutes → jours** | ❌ **NON implémenté** | Aucune logique de conversion visible |
        | **Taux horaire majoré (x2.5)** | ❌ **NON implémenté** | Pas de calcul spécifique |
        | **Intégration dans fiche de paie** | ❌ **NON implémenté** | Champ `notes` vide |

    ✅ Partie fonctionnelle :
        - Détection et enregistrement des retards
        - Génération d'alertes automatiques

    ❌ Partie manquante (à développer) :
        1. Logique de déduction automatique :
            - Si congé disponible → soustraire du solde (conversion minutes → jours)
            - Si congé épuisé → calculer déduction salariale (taux horaire × 2.5)

        2. Intégration avec la paie :
        - Mettre à jour le champ "deductions" dans core_payroll
        - Ajouter des notes explicatives (ex: "Déduction retard: 6h × 14,423 Ar")

        3. Automatisation du workflow :
        - Traiter les alertes "LATE" automatiquement
        - Lier les retards à la génération de la fiche de paie mensuelle
}

.pauses {
    -y'a des types d'entreprise qui par exemples rentrent à 8h du mat, rentre à 12h, pause 30mn et entre les 30mn et le travail effectif => y'a encore 5mn 
    -et c'est tolerable si ça depasse pas les 5mn et c'est plus tolerables si ça depasse ou est pluss de 5mn

    non-implémenté :
        1️⃣ Aucun champ dédié aux pauses dans la base de données
            ❌ Aucun champ : break_minutes, lunch_duration, pause_minutes
        2️⃣ Aucune logique de validation dans le code
            ❌ Recherche "pause|break_time|lunch_break" → 0 résultat
            ❌ Recherche "tolerance|tolerable" → 0 résultat
            ❌ Recherche "clean|validate.*pause" → 0 résultat lié aux pauses
        3️⃣ Aucune alerte générée pour pauses excessives
            -- Test avec pause de 40 min (non tolérable)
            SELECT * FROM core_alerte WHERE date_creation::date = '2025-01-30';
            Résultat : 0 lignes ❌
        
        ❌ Aucun calcul automatique des pauses :
            .Le système ne déduit PAS automatiquement la pause de 30 min
            .Le système ne valide PAS si la pause respecte les règles (≤ 35 min)
            .Le système accepte même des pauses absurdes (240 min = 4 heures !)
        
        dans models.py :
            ❌ Aucun champ break_minutes ou pause_duration
            ❌ Aucune méthode calculate_worked_minutes()
            ❌ Aucune validation de la cohérence pause/temps de travail
        
        dans signals.py (method presence_post_save) :
            ✅ Le système détecte les retards (minutes_late)
            ❌ Le système ne détecte PAS les pauses excessives
            ❌ Aucune logique de type if pause > 35: create_alert()
        
        dans views.py (_presence_summary) :
            # Fait juste la SOMME des worked_minutes, sans calcul ni validation
            Le système utilise `worked_minutes` **tel quel**
            - Aucun recalcul basé sur `time_in - time_out - pause_standard`
        
    resumé :
        | Composant | État | Détails |
        |-----------|------|---------|
        | **Champ pause dans BDD** | ❌ | Aucun champ dédié |
        | **Calcul automatique pause** | ❌ | `worked_minutes` est manuel |
        | **Validation pause ≤ 35 min** | ❌ | Aucune règle de validation |
        | **Tolérance de 5 minutes** | ❌ | Concept inexistant dans le code |
        | **Alerte pause excessive** | ❌ | Pas de signal ni de vérification |
        | **Double pointage** | ❌ | Système à pointage unique (time_in/time_out) |
        | **Déduction salaire si pause > 35** | ❌ | Aucun lien avec la paie |

    ✅ Ce qui existe :
        - Enregistrement des heures d'entrée/sortie (time_in, time_out)
        - Champ worked_minutes pour saisir manuellement le temps travaillé
    
    ❌ Ce qui manque (à développer) :
        1. Structure de données :
            - Ajouter un champ "pause_minutes" ou "break_duration" dans core_presence
            - Ou : Ajouter pause_standard dans les paramètres du contrat

        2. Calcul automatique :
            - worked_minutes = (time_out - time_in) - pause_standard
            - Exemple : (18h - 8h) - 30min = 570 minutes

        3. Règles de tolérance :
            - Pause standard : 30 minutes
            - Tolérance : +5 minutes maximum
            - Si pause > 35 min → Créer alerte "PAUSE_EXCESSIVE"

        4. Validation interface :
            - Empêcher la saisie de worked_minutes incohérents
            - Message d'erreur si : worked_minutes > (time_out - time_in)

        5. Intégration avec la paie :
            - Si pause > 35 min → Déduire le temps excédentaire du salaire
            - Ou : Convertir en retard et appliquer les règles de retard

        6. Option avancée : Double pointage
            - Permettre 4 pointages par jour (entrée/sortie × 2)
            - Calculer automatiquement la durée de pause réelle

    Aucune vérification :
        Vous pouvez mettre worked_minutes = 1000 → accepté
        Vous pouvez mettre worked_minutes = 0 pour une journée complète → accepté
    Pour la paie :
        La fonction _presence_summary additionne bêtement tous les worked_minutes
        Si vous avez mal saisi, la paie sera fausse
}

.Génération automatique du relevé de présence {
    -Fonctionnalité IMPLÉMENTÉE
    -La fonctionnalité de génération de relevé de présence existe et fonctionne, mais elle n'a pas encore été utilisée dans votre système.
        c'est-à-dire qu'y'a pas de bouton concretement dans l'application pour generer mais on peut juste tester avec :
            python manage.py generate_presence_report --start 2025-01-01 --end 2025-01-31 --format xlsx --create-report
            ou tester ceci dans le navigateur : http://localhost:8000/admin/reports/presence/generate/
    
    à implementer quand on fait : http://localhost:8000/admin/reports/presence/generate/
    **Cette page devrait afficher :**
        - Un formulaire avec :
        - Date de début
        - Date de fin
        - Département (optionnel)
        - Format (xlsx/csv)
        - Un bouton "Générer le rapport"
    ou juste un bouton "Générer le rapport" ou "Générer relevé quelque part peut etre dans liste des présences 

     
}


.Interface d’intégration avec la paie {
    *a propos de absence et pointage => concerne la paie apres car si on finit le congé => on prends avec la paie


}
